CREATE SCHEMA IF NOT EXISTS store;
SET search_path TO store;

CREATE USER root WITH PASSWORD 'root';
GRANT ALL PRIVILEGES ON DATABASE postgres TO root;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA store TO root;

DROP TABLE IF EXISTS users CASCADE;
CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE
);

DROP TABLE IF EXISTS user_info CASCADE;
CREATE TABLE user_info (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    userId BIGINT NOT NULL,
    address1 VARCHAR(255),
    address2 VARCHAR(255),
    city VARCHAR(255),
    region VARCHAR(255),
    postalCode VARCHAR(255),
    country VARCHAR(255),
    FOREIGN KEY (userId) REFERENCES users(id)
);

DROP TABLE IF EXISTS products CASCADE;
CREATE TABLE products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    imageHref VARCHAR(255),
    price NUMERIC(10, 2) NOT NULL
);

DROP TABLE IF EXISTS checkout CASCADE;
CREATE TABLE checkout (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    userId BIGINT NOT NULL,
    userInfoId BIGINT NOT NULL,
    subtotal NUMERIC(10, 2) NOT NULL,
    discounts NUMERIC(10, 2) NOT NULL,
    tax NUMERIC(10, 2) NOT NULL,
    shipping NUMERIC(10, 2) NOT NULL,
    total NUMERIC(10, 2) NOT NULL,
    FOREIGN KEY (userId) REFERENCES users(id),
    FOREIGN KEY (userInfoId) REFERENCES user_info(id)
);

DROP TABLE IF EXISTS checkout_items CASCADE;
CREATE TABLE checkout_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    checkoutId BIGINT NOT NULL,
    productId BIGINT NOT NULL,
    productName VARCHAR(255) NOT NULL,
    imageHref VARCHAR(255),
    quantity INT NOT NULL,
    total NUMERIC(10, 2) NOT NULL,
    FOREIGN KEY (checkoutId) REFERENCES orders(id),
    FOREIGN KEY (productId) REFERENCES products(id)
);

DROP TABLE IF EXISTS orders CASCADE;
CREATE TABLE orders (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    checkoutId BIGINT NOT NULL,
    userId BIGINT NOT NULL,
    userInfoId BIGINT NOT NULL,
    FOREIGN KEY (userId) REFERENCES users(id),
    FOREIGN KEY (userInfoId) REFERENCES user_info(id),
    FOREIGN KEY (checkoutId) REFERENCES checkout(id)
);

DROP TABLE IF EXISTS orders_credix CASCADE;
CREATE TABLE orders_credix (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    orderId BIGINT NOT NULL,
    userId BIGINT NOT NULL,
    payload JSON,
    response JSON,
    response_status INT,

    FOREIGN KEY (userId) REFERENCES users(id),
    FOREIGN KEY (orderId) REFERENCES orders(id)
);

